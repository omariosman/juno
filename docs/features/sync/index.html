<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Juno Documentation üå† RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Juno Documentation üå† Atom Feed"><title data-react-helmet="true">Synchronization | Juno Documentation üå†</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://gojuno.xyz/docs/features/sync"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Synchronization | Juno Documentation üå†"><meta data-react-helmet="true" name="description" content="There are currently two methods to synchronize with the StarkNet chain (i.e., download, hold, and update the StarkNet state):"><meta data-react-helmet="true" property="og:description" content="There are currently two methods to synchronize with the StarkNet chain (i.e., download, hold, and update the StarkNet state):"><link data-react-helmet="true" rel="icon" href="/img/juno_small.jpg"><link data-react-helmet="true" rel="canonical" href="https://gojuno.xyz/docs/features/sync"><link data-react-helmet="true" rel="alternate" href="https://gojuno.xyz/docs/features/sync" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://gojuno.xyz/docs/features/sync" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.37445f41.css">
<link rel="preload" href="/assets/js/runtime~main.d132c78e.js" as="script">
<link rel="preload" href="/assets/js/main.26e815d4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/juno.svg" alt="Juno Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/juno.svg" alt="Juno Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Juno</b></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/NethermindEth/juno" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">üåú</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">üåû</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y"><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Welcome</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/getting-started">Getting Started</a><button aria-label="Toggle the collapsible sidebar category &#x27;Getting Started&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/contribution-guidelines">Contribution Guidelines</a><button aria-label="Toggle the collapsible sidebar category &#x27;Contribution Guidelines&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/future-implementations">Future Implementations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Future Implementations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/running">Running</a><button aria-label="Toggle the collapsible sidebar category &#x27;Running&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_VCh3" aria-current="page" href="/docs/category/features">Features</a><button aria-label="Toggle the collapsible sidebar category &#x27;Features&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/features/cryptography">Cryptographic basis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/features/feeder-gateway">Feeder Gateway Connection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/features/merkle-tree">Merkle Tries Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/features/rest">REST API</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/features/rpc">RPC Server</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/features/sync">Synchronization</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_VCh3" href="/docs/category/testing">Testing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Testing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><div class="theme-doc-markdown markdown"><header><h1>Synchronization</h1></header><p>There are currently two methods to synchronize with the StarkNet chain (i.e., download, hold, and update the StarkNet state):</p><ol><li>the Starkware feeder gateway (a centralized API provided by StarkWare) or</li><li>the Layer 1 StarkNet contracts on the Ethereum chain (these contracts hold the StarkNet data on-chain, providing data availability)</li></ol><p>The syncing process with the feeder gateway is relatively simple: request a state update from the API <a href="https://alpha-mainnet.starknet.io/feeder_gateway/get_state_update?blockNumber=0" target="_blank" rel="noopener noreferrer">like this</a>
and apply that state update to the local database. </p><p>Syncing with the L1 contracts is more complicated. To do this, we listen for events emitted by the contracts to reconstruct the StarkNet state update.
The three key StarkNet contracts on L1 that we are interested in are:</p><ol><li>MemoryPageFactRegistry: stores a mapping between a fact (a hash of some data) and a memory page hash.
This contract has an external function <code>registerMemoryPageContinuous</code> that accepts memory pages as input (data structure that contains L2 transaction data).
When it receives a new valid memory page, the <code>LogMemoryPageFactContinuous</code> event is emitted with the hash of the registered memory page.</li><li>GpsStatementVerifier: verifies proofs from layer 2.
When this contract verifies a proof, it emits a <code>LogMemoryPagesHashes</code> event, which contains a fact (hash of data used in the verification process) and an array of memory page hashes.</li><li>Starknet: transitions the StarkNet state.
Emits a <code>LogStateTransitionFact</code> event with a fact corresponding to the state transition being processed.
Once it completes additional safety checks, it will officially transition the state and emit a <code>LogStateUpdate</code> event with the new state root and Starknet block number (sequence number).</li></ol><p>When syncing against L1, we need to work backwards through the above steps to reconstruct the original state update.</p><p>Since we cannot rely on receiving the events in chronological order, we hold three mappings to keep the information straight (one for each contract):</p><ol><li>memoryPage: memoryPageHash -&gt; hash of the Ethereum transaction where the <code>LogMemoryPageFactContinuous</code> event was emitted.</li><li>gpsVerifier: fact1 -&gt; list of memory page hashes</li><li>facts: sequence number -&gt; fact (this fact is from <code>LogStateTransitionFact</code>, sequence number is from <code>LogStateUpdate</code>)</li></ol><p>To sync, we follow these steps:</p><ol><li>Once we see a <code>LogStateTransitionFact</code> event, we look for a <code>LogStateUpdate</code> in the same Ethereum block. If found, we add it to the third mapping above.
If the sequence number (StarkNet block number) is one greater than the latest sequence number of the last block we synced, we begin processing the state update.</li><li>Use the fact from the <code>LogStateTransitionFact</code> event to get the list of corresponding memory page hashes from the gpsVerifier mapping.</li><li>For each memory page hash, use the memoryPage mapping to find the hash of the transaction where the memory page data was sent.</li><li>Query an Ethereum node for the actual transaction using the transaction hash.</li><li>Parse the Ethereum transaction calldata to reconstruct the StarkNet state update.</li></ol><p>Further exploration:</p><ol><li><a href="https://docs.starknet.io/docs/State/starknet-state" target="_blank" rel="noopener noreferrer">StarkNet State</a> - layout of the StarkNet state trie</li><li><a href="https://ethresear.ch/t/batching-proofs-for-several-dapps-into-a-single-succinct-proof/5694" target="_blank" rel="noopener noreferrer">Fact registry design</a> - the reasoning behind the StarkNet L1 contract architecture</li><li><a href="https://github.com/starkware-libs/starkex-contracts/tree/master/evm-verifier" target="_blank" rel="noopener noreferrer">StarkEx contracts on GitHub</a> - contain initial implementations of the MemoryPageFactRegistry and GpsStatementVerifier contracts for StarkEx</li><li><a href="https://goerli.etherscan.io/address/0x5e6229F2D4d977d20A50219E521dE6Dd694d45cc#code" target="_blank" rel="noopener noreferrer">StarkNet contract on Goerli</a> (may be out of date by the time you&#x27;re reading this)</li><li><a href="https://eprint.iacr.org/2021/1063" target="_blank" rel="noopener noreferrer">Cairo white paper</a> - useful background knowledge to have while reading the above contracts</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/NethermindEth/juno/tree/main/docs/docs/features/sync.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/features/rpc"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">RPC Server</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/category/testing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Testing</div></a></div></nav></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/sqFY2D48GS" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://nethermind.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Nethermind<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2022 Juno. Made with ‚ù§Ô∏è by Nethermind.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d132c78e.js"></script>
<script src="/assets/js/main.26e815d4.js"></script>
</body>
</html>